#!/bin/bash

if [[ ! -d ${PARFLOW_SRC_DIR}  ]]
then
  echo "Can't find PARFLOW_SRC_DIR : ${PARFLOW_SRC_DIR}"
fi

cd ${PARFLOW_SRC_DIR}/..

mkdir -p build

cd build

BUILD_DIR=$(pwd)

echo "-----------------------------------------------------------------------------"
echo "Building ParFlow"
echo "  Source directory : ${PARFLOW_SRC_DIR}"
echo "  Build directory : ${BUILD_DIR}"
echo "  Install directory : ${PARFLOW_DIR}"
echo "-----------------------------------------------------------------------------"

#-----------------------------------------------------------------------------
# Configure pfsimulator
#-----------------------------------------------------------------------------
echo "-----------------------------------------------------------------------------"
echo "Configure pfsimulator"
mkdir -p ${BUILD_DIR}/pfsimulator
cd  ${BUILD_DIR}/pfsimulator

echo "Configure pfsimulator"

cmd="CC=${PARFLOW_CC} CXX=${PARFLOW_CXX} F77=${PARFLOW_F77} FC=${PARFLOW_FC} CFLAGS=${PARFLOW_FLAGS} \
  ${PARFLOW_SRC_DIR}/pfsimulator/configure \
    --with-amps=mpi1 \
    --with-amps-sequential-io \
    --with-MPICC=cc \
    --with-hypre=${PARFLOW_HYPRE_DIR} \
    --with-sundials=${PARFLOW_SUNDIALS_DIR} \
    --with-silo=${PARFLOW_SILO_DIR} \
    --with-hdf5=${PARFLOW_HDF5_DIR} \
    --with-clm \
    --with-slurm=${PARFLOW_SLURM_DIR} \
    --enable-timing \
    --prefix=$PARFLOW_DIR"

echo $cmd
eval $cmd

echo "-----------------------------------------------------------------------------"
echo "Building pfsimulator"

make
make install

#-----------------------------------------------------------------------------
# Configure pftools
#-----------------------------------------------------------------------------
mkdir -p ${BUILD_DIR}/pftools
cd ${BUILD_DIR}/pftools

echo "Configure pftools"

cmd="CC=${PARFLOW_CC} CXX=${PARFLOW_CXX} F77=${PARFLOW_F77} FC=${PARFLOW_FC} \
   ${PARFLOW_SRC_DIR}/pftools/configure \
   --with-tcl=${PARFLOW_TCL_DIR} \
   --with-amps=mpi1 \
   --with-amps-sequential-io \
   --with-silo=${PARFLOW_SILO_DIR} \
   --with-hdf5=${PARFLOW_HDF5_DIR} \
   --prefix=${PARFLOW_DIR}"

echo $cmd
eval $cmd

echo "-----------------------------------------------------------------------------"
echo "Building pftools"

make
make install




